rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES HELPER
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isEspecialista(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role in ['admin', 'especialista'];
    }
    
    function isMember(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }
    
    // ============================================================
    // COLECCIÓN: users
    // Estructura de roles:
    // - "usuario": Nuevo usuario, puede crear/unirse a centros
    // - "admin": Creador de centro, gestiona su organización
    // - "miembro": Miembro de un centro
    // - "especialista": Terapeuta/especialista en un centro
    // ============================================================
    match /users/{userId} {
      // Solo el usuario puede leer sus propios datos
      allow read: if request.auth.uid == userId;
      
      // Crear con rol "usuario"
      allow create: if request.auth.uid == userId;
      
      // Actualizar: solo campos permitidos
      allow update: if request.auth.uid == userId;
      
      // Nunca permitir borrar
      allow delete: if false;
    }
    
    // ============================================================
    // COLECCIÓN: organizations
    // ============================================================
    match /organizations/{orgId} {
      // Leer: miembros de la organización O publicamente (para que puedan unirse)
      allow read: if isMember(orgId) || isAuthenticated();
      
      // Crear: cualquiera autenticado
      allow create: if isAuthenticated();
      
      // Actualizar: solo admins de la organización O creador
      allow update: if isAdmin(orgId) || (get(/databases/$(database)/documents/organizations/$(orgId)).data.createdBy == request.auth.uid);
      
      // Borrar: nunca
      allow delete: if false;
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/members
      // ============================================================
      match /members/{userId} {
        // Leer: solo miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: simplemente verificar que es autenticado y que el userId coincida
        allow create: if isAuthenticated() && request.auth.uid == userId;
        
        // Actualizar: solo admins pueden cambiar roles de otros
        allow update: if isAdmin(orgId)
                      && !('organizationId' in request.resource.data.diff.changedKeys());
        
        // Borrar: solo admins
        allow delete: if isAdmin(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/buttons
      // Botones de comunicación aumentativa
      // ============================================================
      match /buttons/{buttonId} {
        // Leer: miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: especialistas y admins
        allow create: if isEspecialista(orgId)
                      && request.resource.data.keys().hasAll(['text', 'organizationId'])
                      && request.resource.data.organizationId == orgId;
        
        // Actualizar: especialistas y admins
        allow update: if isEspecialista(orgId)
                      && !('organizationId' in request.resource.data.diff.changedKeys());
        
        // Borrar: admins
        allow delete: if isAdmin(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/profiles
      // Perfiles de pacientes
      // ============================================================
      match /profiles/{profileId} {
        // Leer: miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: especialistas y admins
        allow create: if isEspecialista(orgId)
                      && request.resource.data.keys().hasAll(['name', 'organizationId'])
                      && request.resource.data.organizationId == orgId;
        
        // Actualizar: especialistas y admins
        allow update: if isEspecialista(orgId)
                      && !('organizationId' in request.resource.data.diff.changedKeys());
        
        // Borrar: solo admins
        allow delete: if isAdmin(orgId);
        
        // Sub-colección: estadísticas del perfil
        match /stats/{statId} {
          allow read: if isMember(orgId);
          allow write: if isMember(orgId);
        }
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/games
      // Progreso de juegos educativos
      // ============================================================
      match /games/{gameProgressId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/forum
      // Foro educativo
      // ============================================================
      match /forum/{threadId} {
        allow read: if isMember(orgId);
        allow create: if isMember(orgId)
                      && request.resource.data.keys().hasAll(['title', 'content'])
                      && request.resource.data.authorId == request.auth.uid;
        allow update: if isMember(orgId)
                      && request.resource.data.authorId == request.auth.uid;
        allow delete: if isEspecialista(orgId);
        
        // Respuestas del foro
        match /replies/{replyId} {
          allow read: if isMember(orgId);
          allow create: if isMember(orgId)
                        && request.resource.data.authorId == request.auth.uid;
          allow update: if isMember(orgId)
                        && request.resource.data.authorId == request.auth.uid;
          allow delete: if isEspecialista(orgId);
        }
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/auditLog
      // Registro de auditoría para cambios y acciones
      // ============================================================
      match /auditLog/{logId} {
        // Leer: admins y especialistas de la organización
        allow read: if isEspecialista(orgId) || isAdmin(orgId);
        
        // Crear: sistema (Server Rules y Cloud Functions)
        allow create: if false;
        
        // Actualizar: nunca
        allow update: if false;
        
        // Borrar: nunca
        allow delete: if false;
      }
    }
    
    // ============================================================
    // COLECCIÓN: users/{userId}/notifications
    // Notificaciones en tiempo real para usuarios
    // ============================================================
    match /users/{userId}/notifications/{notificationId} {
      // Leer: solo el usuario propietario
      allow read: if request.auth.uid == userId;
      
      // Crear: sistema (Cloud Functions)
      allow create: if false;
      
      // Actualizar: solo el usuario puede marcar como leída o actualizaciones mínimas
      allow update: if request.auth.uid == userId
                    && (request.resource.data.diff.changedKeys().hasOnly(['read', 'updatedAt']));
      
      // Borrar: solo el usuario
      allow delete: if request.auth.uid == userId;
    }
    
    // ============================================================
    // COLECCIÓN: public_resources
    // Recursos públicos (noticias, tutoriales, etc)
    // ============================================================
    match /public_resources/{resourceId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ============================================================
    // DEFAULT: Denegar todo
    // ============================================================
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}

