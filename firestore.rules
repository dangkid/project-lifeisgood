rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES HELPER
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
             && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isEspecialista(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
             && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role in ['admin', 'especialista'];
    }
    
    function isMember(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================================
    // COLECCIÓN: users
    // ============================================================
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer cualquier perfil de usuario
      allow read: if isAuthenticated();
      
      // Crear: solo el propio usuario al registrarse
      allow create: if isOwner(userId);
      
      // Actualizar: solo el propio usuario o admin de su organización
      allow update: if isOwner(userId) || 
                    (resource.data.organizationId != null && isAdmin(resource.data.organizationId));
      
      // Borrar: nunca (sistema mantiene historial)
      allow delete: if false;
    }
    
    // ============================================================
    // COLECCIÓN: organizations
    // ============================================================
    match /organizations/{orgId} {
      // Leer: cualquier usuario autenticado puede ver organizaciones
      allow read: if isAuthenticated();
      
      // Crear: cualquier usuario autenticado puede crear una organización
      allow create: if isAuthenticated();
      
      // Actualizar: solo admins de la organización
      allow update: if isAdmin(orgId);
      
      // Borrar: nunca (sistema mantiene historial)
      allow delete: if false;
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/members
      // ============================================================
      match /members/{userId} {
        // Leer: solo miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: usuarios pueden agregarse a sí mismos O admins pueden agregar otros
        allow create: if isAuthenticated() && 
                      (isOwner(userId) || isAdmin(orgId));
        
        // Actualizar: solo admins pueden cambiar roles
        allow update: if isAdmin(orgId);
        
        // Borrar: solo admins pueden eliminar miembros
        allow delete: if isAdmin(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/profiles
      // Perfiles de pacientes
      // ============================================================
      match /profiles/{profileId} {
        // Leer: miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: especialistas y admins
        allow create: if isEspecialista(orgId)
                      && request.resource.data.keys().hasAll(['name', 'organizationId'])
                      && request.resource.data.organizationId == orgId;
        
        // Actualizar: especialistas y admins
        allow update: if isEspecialista(orgId)
                      && !('organizationId' in request.resource.data.diff.changedKeys());
        
        // Borrar: solo admins
        allow delete: if isAdmin(orgId);
        
        // Sub-colección: estadísticas del perfil
        match /stats/{statId} {
          allow read: if isMember(orgId);
          allow write: if isMember(orgId);
        }
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/buttons
      // Botones de comunicación aumentativa
      // ============================================================
      match /buttons/{buttonId} {
        // Leer: miembros de la organización
        allow read: if isMember(orgId);
        
        // Crear: especialistas y admins
        allow create: if isEspecialista(orgId)
                      && request.resource.data.keys().hasAll(['text', 'organizationId'])
                      && request.resource.data.organizationId == orgId;
        
        // Actualizar: especialistas y admins
        allow update: if isEspecialista(orgId)
                      && !('organizationId' in request.resource.data.diff.changedKeys());
        
        // Borrar: admins
        allow delete: if isAdmin(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/games
      // Progreso de juegos educativos
      // ============================================================
      match /games/{gameProgressId} {
        allow read: if isMember(orgId);
        allow write: if isMember(orgId);
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/forum
      // Foro educativo
      // ============================================================
      match /forum/{threadId} {
        allow read: if isMember(orgId);
        allow create: if isMember(orgId)
                      && request.resource.data.keys().hasAll(['title', 'content'])
                      && request.resource.data.authorId == request.auth.uid;
        allow update: if isMember(orgId)
                      && request.resource.data.authorId == request.auth.uid;
        allow delete: if isEspecialista(orgId);
        
        // Respuestas del foro
        match /replies/{replyId} {
          allow read: if isMember(orgId);
          allow create: if isMember(orgId)
                        && request.resource.data.authorId == request.auth.uid;
          allow update: if isMember(orgId)
                        && request.resource.data.authorId == request.auth.uid;
          allow delete: if isEspecialista(orgId);
        }
      }
      
      // ============================================================
      // SUB-COLECCIÓN: organizations/{orgId}/auditLog
      // Registro de auditoría para cambios y acciones
      // ============================================================
      match /auditLog/{logId} {
        // Leer: admins y especialistas de la organización
        allow read: if isEspecialista(orgId) || isAdmin(orgId);
        
        // Crear: sistema (Server Rules y Cloud Functions)
        allow create: if false;
        
        // Actualizar: nunca
        allow update: if false;
        
        // Borrar: nunca
        allow delete: if false;
      }
    }
    
    // ============================================================
    // COLECCIÓN: users/{userId}/notifications
    // Notificaciones en tiempo real para usuarios
    // ============================================================
    match /users/{userId}/notifications/{notificationId} {
      // Leer: solo el usuario propietario
      allow read: if isOwner(userId);
      
      // Crear: sistema (Cloud Functions)
      allow create: if false;
      
      // Actualizar: solo el usuario puede marcar como leída o actualizaciones mínimas
      allow update: if isOwner(userId)
                    && (request.resource.data.diff.changedKeys().hasOnly(['read', 'updatedAt']));
      
      // Borrar: solo el usuario
      allow delete: if isOwner(userId);
    }
    
    // ============================================================
    // COLECCIÓN: public_resources
    // Recursos públicos (noticias, tutoriales, etc)
    // ============================================================
    match /public_resources/{resourceId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ============================================================
    // DEFAULT: Denegar todo
    // ============================================================
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
