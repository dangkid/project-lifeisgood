# ๐๏ธ ARQUITECTURA DE SEGURIDAD

**Visualizaciรณn de la arquitectura implementada**

---

## ๐ Diagrama General

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   USUARIO (Browser)                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ         App.jsx (React Frontend)                 โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ   โ
โ  โ  โ  AdminRoute                          โ        โ   โ
โ  โ  โ  - Verifica: isUserAdmin() โ SEGURO  โ        โ   โ
โ  โ  โ  - โ NO verifica email              โ        โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ        โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                        โ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  Servicios (services/*.js)                       โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ   โ
โ  โ  โ authService    โ validation.js           โ    โ   โ
โ  โ  โ buttonService  โ - validateButton()      โ    โ   โ
โ  โ  โ profileService โ - validateProfile()     โ    โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                        โ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  Variables de Entorno (.env.local)               โ   โ
โ  โ  โโโ VITE_FIREBASE_API_KEY                       โ   โ
โ  โ  โโโ VITE_FIREBASE_AUTH_DOMAIN                   โ   โ
โ  โ  โโโ VITE_NEWS_API_KEY                           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ HTTPS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   GOOGLE FIREBASE                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  Firestore Database                              โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          โ   โ
โ  โ  โ  Collections:                      โ          โ   โ
โ  โ  โ  - users/                          โ          โ   โ
โ  โ  โ  - organizations/                  โ          โ   โ
โ  โ  โ    - members/                      โ          โ   โ
โ  โ  โ    - buttons/                      โ          โ   โ
โ  โ  โ    - profiles/                     โ          โ   โ
โ  โ  โ    - audit_log/                    โ          โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                        โ                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  FIRESTORE SECURITY RULES (firestore.rules)      โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          โ   โ
โ  โ  โ function isAdmin(orgId)            โ          โ   โ
โ  โ  โ function isEspecialista(orgId)     โ          โ   โ
โ  โ  โ function isMember(orgId)           โ          โ   โ
โ  โ  โ                                    โ          โ   โ
โ  โ  โ Validaciones por colecciรณn:        โ          โ   โ
โ  โ  โ โ users - No cambiar role         โ          โ   โ
โ  โ  โ โ organizations - Solo admin      โ          โ   โ
โ  โ  โ โ buttons - Solo especialista     โ          โ   โ
โ  โ  โ โ members - Solo admin cambios    โ          โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ          โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de Seguridad

### Caso 1: Usuario intenta hacerse Admin

```
1. Usuario abre navegador
   โ
2. Intenta: updateDoc(userRef, { role: 'admin' })
   โ
3. Viaja a Firestore
   โ
4. Firestore evalรบa reglas:
   match /users/{userId}
   allow update: if !('role' in request.resource.data.diff.changedKeys())
   โ
5. โ RECHAZADO: "Permission denied"
   โ
6. Usuario sigue siendo 'miembro'
```

### Caso 2: Admin cambia rol de otro usuario (CORRECTO)

```
1. Admin ve interfaz de admin
   โ
2. Admin: cambiar rol de usuario X a 'especialista'
   โ
3. Servicio llama: await changeUserRole(userId, 'especialista')
   โ
4. Cloud Function (o backend):
   - Verifica que quien llama es admin โ
   - Cambia rol en Firestore
   โ
5. Firestore reglas: โ Admin puede cambiar miembros
   โ
6. Usuario X ahora es 'especialista'
```

---

## ๐ฅ Flujo de Permisos por Rol

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      USUARIO FINAL                       โ
โ                  (Paciente comunicaciรณn)                 โ
โ  โข Puede: Usar botones, hacer frases                    โ
โ  โข NO puede: Crear botones, editar perfiles             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      MIEMBRO                             โ
โ              (Familiar o voluntario)                     โ
โ  โข Puede: Ver botones, ver perfiles                     โ
โ  โข NO puede: Crear, editar, borrar                      โ
โ  โข Organizaciรณn: users/{uid}.role = 'miembro'           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ESPECIALISTA                          โ
โ           (Logopeda, terapeuta del habla)               โ
โ  โข Puede:                                               โ
โ    - Crear botones โ                                   โ
โ    - Editar botones โ                                  โ
โ    - Crear perfiles โ                                  โ
โ    - Editar perfiles โ                                 โ
โ    - Ver historial โ                                   โ
โ  โข NO puede:                                            โ
โ    - Borrar botones โ                                  โ
โ    - Cambiar roles โ                                   โ
โ    - Invitar miembros โ                                โ
โ  โข Organizaciรณn: members/{uid}.role = 'especialista'    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       ADMIN                              โ
โ              (Director de organizaciรณn)                  โ
โ  โข Puede:                                               โ
โ    - Todo lo que especialista โ                        โ
โ    - Borrar botones โ                                  โ
โ    - Cambiar roles โ                                   โ
โ    - Invitar miembros โ                                โ
โ    - Ver auditorรญa โ                                   โ
โ    - Exportar datos โ                                  โ
โ  โข Organizaciรณn: members/{uid}.role = 'admin'           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Validaciรณn de Datos

```
Frontend Input
    โ
validation.js
โโโ validateButton()
โ   โโโ text: requerido, < 100 chars
โ   โโโ category: string vรกlido
โ   โโโ image: URL vรกlida (opcional)
โ   โโโ color: hex o tailwind (opcional)
โ
โโโ validateProfile()
โ   โโโ name: requerido
โ   โโโ age: 0-120 (opcional)
โ   โโโ diagnosis: string (opcional)
โ
โโโ validateUser()
โ   โโโ email: validar formato
โ   โโโ password: > 6 chars
โ   โโโ displayName: no vacรญo
โ
โโโ sanitizeInput()
    โโโ Evitar XSS

    โ
Frontend Validation Pass โ
    โ
Send to Firebase
    โ
Firestore Rules
โโโ Validar nuevamente
โโโ Verificar permisos
โโโ Guardar o rechazar

    โ
Database โ (Datos validados)
```

---

## ๐ Capas de Seguridad

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 1: Cliente (Browser)                             โ
โ โข Validaciรณn input bรกsica                             โ
โ โข Verificaciรณn de UI                                  โ
โ โข NOTA: Cliente NO es seguro, solo UX                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 2: Servicio (JavaScript Services)                โ
โ โข validation.js - Validaciรณn de datos                 โ
โ โข authService.js - Verificaciรณn de rol                โ
โ โข NOTA: Servicio tampoco es seguro, solo lรณgica      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 3: Transporte (HTTPS)                            โ
โ โข Encriptaciรณn de datos en trรกnsito                   โ
โ โข Previene man-in-the-middle                          โ
โ โข NOTA: Firebase Cloud Storage                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 4: Autenticaciรณn (Firebase Auth)                 โ
โ โข Verificar que usuario es quien dice ser             โ
โ โข Tokens JWT seguros                                  โ
โ โข NOTA: Firebase maneja esto                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 5: Autorizaciรณn (Firestore Rules) โ MรS SEGURO   โ
โ โข Verificar permisos por rol                          โ
โ โข Validar cada operaciรณn                              โ
โ โข Prevenir cambios de rol                             โ
โ โข Registrar cambios (auditorรญa)                       โ
โ โข NOTA: Esto NO se puede bypassear desde cliente     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CAPA 6: Datos (Firestore Database)                    โ
โ โข Encriptaciรณn en reposo                              โ
โ โข Backups automรกticos                                 โ
โ โข Recuperaciรณn de desastres                           โ
โ โข NOTA: Google Cloud Infrastructure                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Colecciones y Permisos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ COLECCIรN: users/{userId}                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Campos importantes:                                          โ
โ โข email: string                                             โ
โ โข displayName: string                                       โ
โ โข organizationId: string                                    โ
โ โข role: 'admin' | 'especialista' | 'miembro' | null         โ
โ โข emailVerified: boolean                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Permisos:                                                   โ
โ โข READ: Solo el usuario mismo                              โ
โ โข CREATE: Solo el usuario (sin rol inicial)                โ
โ โข UPDATE: Usuario solo puede cambiar: displayName, foto    โ
โ โข DELETE: NUNCA (falso)                                    โ
โ โข CAMBIAR ROLE: IMPOSIBLE desde cliente                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ COLECCIรN: organizations/{orgId}                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Campos importantes:                                          โ
โ โข name: string                                              โ
โ โข description: string                                       โ
โ โข createdAt: timestamp                                      โ
โ โข createdBy: userId                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Permisos:                                                   โ
โ โข READ: Miembros de la org                                 โ
โ โข CREATE: Cualquier usuario (crea su org)                  โ
โ โข UPDATE: Solo admins de la org                            โ
โ โข DELETE: NUNCA (falso)                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SUB-COLECCIรN: organizations/{orgId}/members/{userId}      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Campos importantes:                                          โ
โ โข role: 'admin' | 'especialista' | 'miembro'                โ
โ โข joinedAt: timestamp                                       โ
โ โข invitedBy: userId                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Permisos:                                                   โ
โ โข READ: Otros miembros de la org                           โ
โ โข CREATE: Usuario se agrega a sรญ mismo (como 'miembro')    โ
โ โข UPDATE: Solo admin puede cambiar roles                   โ
โ โข DELETE: Solo admin                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SUB-COLECCIรN: organizations/{orgId}/buttons/{id}          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Campos importantes:                                          โ
โ โข text: string                                              โ
โ โข category: string                                          โ
โ โข image: URL (opcional)                                     โ
โ โข createdAt: timestamp                                      โ
โ โข createdBy: userId                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Permisos:                                                   โ
โ โข READ: Miembros de la org                                 โ
โ โข CREATE: Admin, especialista                              โ
โ โข UPDATE: Admin, especialista (no cambiar org)             โ
โ โข DELETE: Solo admin                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SUB-COLECCIรN: organizations/{orgId}/audit_log/{id}        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Campos:                                                     โ
โ โข action: 'create' | 'update' | 'delete'                    โ
โ โข userId: string                                            โ
โ โข timestamp: date                                           โ
โ โข collection: string                                        โ
โ โข changes: object                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Permisos:                                                   โ
โ โข READ: Miembros de la org (ver quรฉ cambiรณ)                โ
โ โข WRITE: Automรกtico por Cloud Functions                    โ
โ โข DELETE: NUNCA (inmutable)                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐จ Ataque Bloqueado

```
INTENTO DE ATAQUE 1: Email Spoofing
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Atacante:                                            โ
โ 1. Cambia displayName a "Oliver" (admin)             โ
โ 2. Abre /admin                                       โ
โ 3. Espera... โ RECHAZADO                            โ
โ                                                      โ
โ Motivo:                                              โ
โ AdminRoute ahora usa isUserAdmin()                   โ
โ que verifica FIRESTORE, no email/displayName         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

INTENTO DE ATAQUE 2: Cambiar Rol
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Atacante (usuario miembro):                          โ
โ 1. Abre DevTools (F12)                               โ
โ 2. Ejecuta:                                          โ
โ    await updateDoc(userRef, { role: 'admin' })       โ
โ 3. Espera... โ RECHAZADO                            โ
โ                                                      โ
โ Motivo:                                              โ
โ Firestore Rules bloquean cambios de 'role'           โ
โ El cliente NO puede cambiar su propio rol            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

INTENTO DE ATAQUE 3: Datos Corruptos
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Atacante:                                            โ
โ 1. Envรญa botรณn con: { text: '', color: 'invalid' }  โ
โ 2. Firestore intenta guardar                         โ
โ 3. ... โ RECHAZADO (en Semana 2)                    โ
โ                                                      โ
โ Motivo:                                              โ
โ Cloud Functions validarรกn datos                      โ
โ O Firestore Rules impedirรกn guardar invรกlido         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ Defensa en Profundidad

```
Si alguien hackea...       | Defensa siguiente:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
Cliente (browser)          โ Servidor valida (Firestore Rules)
Variables .env             โ Claves restringidas por dominio
Firestore Rules temporales โ Admin backend hace cambios reales
API/Servicios              โ HTTPS encriptado
Servidor                   โ Google Cloud seguridad fรญsica
Base de datos              โ Encriptaciรณn en reposo + Backups
```

---

## ๐ Referencias

- [Firestore Security Docs](https://firebase.google.com/docs/firestore/security/start)
- [OWASP Security Cheat Sheet](https://cheatsheetseries.owasp.org/)
- [Firebase Best Practices](https://firebase.google.com/docs/auth/best-practices)

---

**Conclusiรณn:** La seguridad estรก en CAPAS. Si una falla, la siguiente las protege. โ
